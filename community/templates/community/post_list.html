{# community/templates/community/post_list.html #}
{% extends 'base.html' %}
{% load static %}
{% load humanize %} {# لتحويل الأرقام الكبيرة إلى تنسيق سهل القراءة مثل 1K, 1M #}
{% load journal_extras %} {# لاستخدام الفلتر get_item #}

{% block title %}مجتمع التعافي{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-surface rounded-3xl shadow-2xl p-6 md:p-8 my-8 animate-fade-in-up">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-8" style="color: var(--color-text-primary);">
        <i class="fas fa-comments text-secondary mr-3"></i> مجتمع التعافي
    </h1>

    <p class="text-lg text-center text-gray-700 mb-10">
        تواصل مع الآخرين في رحلة التعافي. شارك قصتك، اطرح الأسئلة، واحصل على الدعم.
    </p>

    {# نموذج إنشاء منشور جديد #}
    <div class="mb-10 p-6 bg-gray-50 rounded-2xl shadow-inner border border-gray-200">
        <h2 class="text-2xl font-bold mb-4" style="color: var(--color-text-primary);">إنشاء منشور جديد</h2>
        <form method="post" action="{% url 'community:post_create' %}">
            {% csrf_token %}
            {{ create_post_form.as_p }}
            <button type="submit" class="mt-4 inline-flex items-center justify-center bg-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-primary-dark transition duration-300">
                <i class="fas fa-plus mr-2 rtl:mr-0 rtl:ml-2"></i> نشر الآن
            </button>
        </form>
    </div>

    {# شريط البحث والفرز #}
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 space-y-4 md:space-y-0 md:space-x-4 rtl:space-x-reverse">
        <form method="GET" action="{% url 'community:post_list' %}" class="w-full md:w-1/2">
            <div class="relative">
                <input type="text" name="q" placeholder="البحث في المنشورات..." value="{{ query }}"
                       class="w-full bg-gray-50 border border-gray-300 rounded-full py-2 px-5 pr-10 rtl:pr-5 rtl:pl-10 focus:outline-none focus:ring-2 focus:ring-primary-light">
                <button type="submit" class="absolute left-3 rtl:left-auto rtl:right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
        <form method="GET" action="{% url 'community:post_list' %}" class="w-full md:w-1/3">
            <select name="sort" onchange="this.form.submit()"
                    class="w-full bg-gray-50 border border-gray-300 rounded-full py-2 px-5 focus:outline-none focus:ring-2 focus:ring-primary-light">
                <option value="-created_at" {% if sort_by == "-created_at" %}selected{% endif %}>الأحدث</option>
                <option value="created_at" {% if sort_by == "created_at" %}selected{% endif %}>الأقدم</option>
                {# يمكنك إضافة خيارات فرز أخرى مثل الأكثر إعجابًا #}
            </select>
        </form>
    </div>

    {# قائمة المنشورات #}
    {% if page_obj %}
        <div class="space-y-6">
            {% for post in page_obj %}
                <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-200
                            transform hover:scale-[1.005] transition duration-300 ease-in-out">
                    <div class="flex items-center mb-3">
                        {% comment %} أيقونة الملف الشخصي أو صورة افتراضية {% endcomment %}
                        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-lg flex-shrink-0 mr-3 rtl:mr-0 rtl:ml-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <a href="#" class="font-bold text-primary-dark hover:underline">{{ post.user.username }}</a>
                            {% if post.user.profile.is_verified %} {# التحقق من الحساب الموثق #}
                                <i class="fas fa-check-circle text-blue-500 text-xs mr-1" title="حساب موثق"></i>
                            {% endif %}
                            <p class="text-sm text-gray-500">بتاريخ {{ post.created_at|date:"j F Y, P" }}</p>
                        </div>
                        {# زر المتابعة #}
                        {% comment %} {% if request.user.is_authenticated and request.user != post.user %}
                            <div class="ml-auto rtl:ml-0 rtl:mr-auto">
                                {% with user_is_following=request.user in post.user.followers.all %} {# <-- تم التعديل هنا #}
                                    {% include 'community/partials/follow_button.html' with target_user=post.user user_is_following=user_is_following %}
                                {% endwith %}
                            </div>
                        {% endif %} {% endcomment %}
                    </div>
                    <a href="{% url 'community:post_detail' pk=post.pk %}" class="block text-primary-dark hover:underline">
                        <h2 class="text-2xl font-bold mb-2 leading-snug">{{ post.title }}</h2>
                    </a>
                    <p class="text-gray-700 mb-4 line-clamp-3">{{ post.rendered_content|safe }}</p> {# <-- تم التعديل هنا #}
                    <div class="flex justify-between items-center text-sm text-gray-500 mt-4 pt-3 border-t border-gray-100">
                        <div class="flex items-center space-x-4 rtl:space-x-reverse">
                            {# زر الإعجاب بالمنشور #}
                            {% include 'community/partials/like_button.html' with object_id=post.id likes_count=post.get_likes_count user_has_liked=post.id in liked_post_ids content_type_id=post_content_type_id is_post=True %}
                            
                            {# زر التعليقات #}
                            <a href="{% url 'community:post_detail' pk=post.pk %}#comments" class="text-gray-600 hover:text-secondary transition duration-200">
                                <i class="fas fa-comment mr-1 rtl:mr-0 rtl:ml-1"></i> {{ post.comments.count|intcomma }} تعليقات
                            </a>
                            
                            {# زر الإبلاغ عن المحتوى #}
                            {% if request.user.is_authenticated and request.user != post.user %}
                                <a href="{% url 'community:report_content' content_type_id=post_content_type_id object_id=post.id %}"
                                   class="text-gray-600 hover:text-orange-500 transition duration-200" title="الإبلاغ عن هذا المنشور">
                                    <i class="fas fa-flag mr-1 rtl:mr-0 rtl:ml-1"></i> إبلاغ
                                </a>
                            {% endif %}

                        </div>
                        <div class="flex items-center space-x-3 rtl:space-x-reverse">
                            {# أزرار التعديل والحذف (فقط للمالك أو المشرف) #}
                            {% if request.user == post.user or request.user.is_superuser %}
                                <a href="{% url 'community:post_edit' pk=post.pk %}" class="text-blue-500 hover:text-blue-700 transition duration-200">
                                    <i class="fas fa-edit"></i> تعديل
                                </a>
                                <a href="{% url 'community:post_delete' pk=post.pk %}" class="text-red-500 hover:text-red-700 transition duration-200">
                                    <i class="fas fa-trash-alt"></i> حذف
                                </a>
                            {% endif %}
                            {# زر إرسال رسالة خاصة (إذا لم يكن المالك نفسه) #}
                            {% if request.user.is_authenticated and request.user != post.user %}
                                <a href="{% url 'community:start_new_conversation' user_id=post.user.id %}" class="text-purple-500 hover:text-purple-700 transition duration-200" title="إرسال رسالة خاصة">
                                    <i class="fas fa-envelope"></i> رسالة
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {# Pagination #}
        {% if page_obj.has_other_pages %}
            <div class="pagination flex justify-center items-center space-x-4 rtl:space-x-reverse mt-10">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
                       class="pagination-link bg-primary text-white py-2 px-4 rounded-full hover:bg-primary-dark transition duration-200">السابق</a>
                {% endif %}
                <span class="current-page text-lg font-semibold text-gray-700">
                    صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
                       class="pagination-link bg-primary text-white py-2 px-4 rounded-full hover:bg-primary-dark transition duration-200">التالي</a>
                {% endif %}
            </div>
        {% endif %}

    {% else %}
        <div class="text-center p-8 bg-gray-50 rounded-lg shadow-inner border border-gray-200 animate-fade-in-up">
            <p class="text-xl text-gray-600 mb-4">
                <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i> لا توجد منشورات في المجتمع حتى الآن.
            </p>
            <p class="text-md text-gray-500">
                كن أول من يشارك أفكاره! <a href="{% url 'community:post_create' %}" class="text-primary-dark hover:underline">انشئ منشورًا جديدًا</a>.
            </p>
        </div>
    {% endif %}
</div>
