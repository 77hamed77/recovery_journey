{# community/templates/community/post_detail.html #}
{% extends 'base.html' %}
{% load static %}
{% load humanize %} {# لتحويل الأرقام الكبيرة إلى تنسيق سهل القراءة مثل 1K, 1M #}
{% load journal_extras %} {# لاستخدام الفلتر get_item #}

{% block title %}منشور: {{ post.title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-surface rounded-3xl shadow-2xl p-6 md:p-8 my-8 animate-fade-in-up">
    {# عنوان المنشور #}
    <h1 class="text-4xl md:text-5xl font-extrabold leading-tight text-center mb-8"
        style="color: var(--color-text-primary);">
        {{ post.title }}
    </h1>

    {# معلومات المنشور #}
    <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
        {# أيقونة الملف الشخصي أو صورة افتراضية #}
        <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-xl flex-shrink-0 mr-4 rtl:mr-0 rtl:ml-4">
            <i class="fas fa-user"></i>
        </div>
        <div>
            <a href="#" class="font-bold text-primary-dark hover:underline text-lg">{{ post.user.username }}</a>
            {% if post.user.profile.is_verified %} {# التحقق من الحساب الموثق #}
                <i class="fas fa-check-circle text-blue-500 text-xs mr-1" title="حساب موثق"></i>
            {% endif %}
            <p class="text-sm text-gray-500">بتاريخ {{ post.created_at|date:"j F Y, P" }}</p>
        </div>
        {# زر المتابعة #}
        {% if request.user.is_authenticated and request.user != post.user %}
            <div class="ml-auto rtl:ml-0 rtl:mr-auto">
                {% include 'community/partials/follow_button.html' with target_user=post.user user_is_following=request.user in post.user.followers.all %}
            </div>
        {% endif %}
    </div>

    {# محتوى المنشور #}
    <div class="prose prose-lg max-w-none text-gray-800 leading-relaxed mb-8 markdown-content" dir="rtl">
        {{ post.rendered_content|safe }} {# <-- تم التعديل هنا #}
    </div>

    {# أزرار الإجراءات (إعجاب، تعليق، تعديل، حذف، رسالة خاصة، إبلاغ) #}
    <div class="flex flex-wrap justify-between items-center text-sm text-gray-500 mt-6 pt-4 border-t border-gray-200 space-y-3 sm:space-y-0">
        <div class="flex items-center space-x-4 rtl:space-x-reverse flex-wrap">
            {# زر الإعجاب بالمنشور #}
            {% include 'community/partials/like_button.html' with object_id=post.id likes_count=post.get_likes_count user_has_liked=post.id in liked_post_ids content_type_id=post_content_type_id is_post=True %}
            
            {# زر التعليقات #}
            <a href="#comments" class="text-gray-600 hover:text-secondary transition duration-200">
                <i class="fas fa-comment mr-1 rtl:mr-0 rtl:ml-1"></i> {{ post.comments.count|intcomma }} تعليقات
            </a>
            
            {# زر الإبلاغ عن المحتوى #}
            {% if request.user.is_authenticated and request.user != post.user %}
                <a href="{% url 'community:report_content' content_type_id=post_content_type_id object_id=post.id %}"
                   class="text-gray-600 hover:text-orange-500 transition duration-200" title="الإبلاغ عن هذا المنشور">
                    <i class="fas fa-flag mr-1 rtl:mr-0 rtl:ml-1"></i> إبلاغ
                </a>
            {% endif %}
        </div>

        <div class="flex items-center space-x-3 rtl:space-x-reverse flex-wrap mt-3 sm:mt-0">
            {# أزرار التعديل والحذف (فقط للمالك أو المشرف) #}
            {% if request.user == post.user or request.user.is_superuser %}
                <a href="{% url 'community:post_edit' pk=post.pk %}" class="text-blue-500 hover:text-blue-700 transition duration-200">
                    <i class="fas fa-edit mr-1 rtl:mr-0 rtl:ml-1"></i> تعديل
                </a>
                <a href="{% url 'community:post_delete' pk=post.pk %}" class="text-red-500 hover:text-red-700 transition duration-200">
                    <i class="fas fa-trash-alt mr-1 rtl:mr-0 rtl:ml-1"></i> حذف
                </a>
            {% endif %}
            {# زر إرسال رسالة خاصة (إذا لم يكن المالك نفسه) #}
            {% if request.user.is_authenticated and request.user != post.user %}
                <a href="{% url 'community:start_new_conversation' user_id=post.user.id %}" class="text-purple-500 hover:text-purple-700 transition duration-200" title="إرسال رسالة خاصة">
                    <i class="fas fa-envelope mr-1 rtl:mr-0 rtl:ml-1"></i> رسالة
                </a>
            {% endif %}
        </div>
    </div>

    {# قسم التعليقات #}
    <div id="comments" class="mt-12 pt-8 border-t border-gray-200">
        <h2 class="text-3xl font-bold mb-6" style="color: var(--color-text-primary);">التعليقات ({{ post.comments.count }})</h2>

        {# نموذج إضافة تعليق جديد #}
        <div class="mb-8 p-6 bg-gray-50 rounded-2xl shadow-inner border border-gray-200">
            <h3 class="text-xl font-bold mb-4">أضف تعليقًا</h3>
            <form method="post" action="{% url 'community:add_comment_to_post' pk=post.pk %}">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" class="mt-4 inline-flex items-center justify-center bg-primary text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-primary-dark transition duration-300">
                    <i class="fas fa-comment mr-2 rtl:mr-0 rtl:ml-2"></i> إضافة تعليق
                </button>
            </form>
        </div>

        {# قائمة التعليقات #}
        {% if comments %}
            <div class="space-y-6">
                {% for comment in comments %}
                    {% include 'community/partials/comment_card.html' with comment=comment level=0 liked_comment_ids=liked_comment_ids post_content_type_id=post_content_type_id comment_content_type_id=comment_content_type_id %}
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-gray-600">لا توجد تعليقات حتى الآن. كن أول من يعلق!</p>
        {% endif %}
    </div>
</div>
