{# community/templates/community/partials/comment_card.html #}
{% load static %}
{% load humanize %}
{% load journal_extras %} {# لاستخدام الفلتر mul إذا كان موجودًا #}

{% comment %} 
    لجعل التعليقات المتداخلة تظهر بمسافة بادئة، نستخدم خاصية `level` الممررة.
    على سبيل المثال، level=0 للتعليقات الرئيسية، level=1 للردود، وهكذا.
{% endcomment %}
<div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-4"
     style="margin-right: {{ level|default:0|mul:20 }}px; margin-left: auto;"> {#rtl:ml-0 rtl:mr-auto#}
    <div class="flex items-center mb-3">
        {# أيقونة الملف الشخصي أو صورة افتراضية #}
        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-sm flex-shrink-0 mr-3 rtl:mr-0 rtl:ml-3">
            <i class="fas fa-user"></i>
        </div>
        <div>
            <span class="font-bold text-primary-dark">{{ comment.user.username }}</span>
            {% if comment.user.profile.is_verified %} {# التحقق من الحساب الموثق #}
                <i class="fas fa-check-circle text-blue-500 text-xs mr-1" title="حساب موثق"></i>
            {% endif %}
            <p class="text-xs text-gray-500">بتاريخ {{ comment.created_at|date:"j F Y, P" }}</p>
        </div>
    </div>
    
    <div class="prose prose-sm max-w-none text-gray-800 leading-relaxed markdown-content" dir="rtl">
        {{ comment.content|safe }} {# استخدام safe لعرض HTML بعد Markdown #}
    </div>

    <div class="flex items-center space-x-4 rtl:space-x-reverse text-sm mt-4 pt-3 border-t border-gray-100">
        {# زر الإعجاب بالتعليق #}
        {% include 'community/partials/like_button.html' with object_id=comment.id likes_count=comment.get_likes_count user_has_liked=comment.id in liked_comment_ids content_type_id=comment_content_type_id is_comment=True %}
        
        {# زر الرد على التعليق #}
        <button 
            hx-get="{% url 'community:add_reply_to_comment' pk=comment.id %}" {# يمكنك استخدام هذا الزر لفتح نموذج رد HTMX #}
            hx-target="#reply-form-{{ comment.id }}"
            hx-swap="outerHTML"
            class="text-gray-600 hover:text-secondary transition duration-200 focus:outline-none"
        >
            <i class="fas fa-reply mr-1 rtl:mr-0 rtl:ml-1"></i> رد
        </button>

        {# زر الإبلاغ عن المحتوى #}
        {% if request.user.is_authenticated and request.user != comment.user %}
            <a href="{% url 'community:report_content' content_type_id=comment_content_type_id object_id=comment.id %}"
               class="text-gray-600 hover:text-orange-500 transition duration-200" title="الإبلاغ عن هذا التعليق">
                <i class="fas fa-flag mr-1 rtl:mr-0 rtl:ml-1"></i> إبلاغ
            </a>
        {% endif %}
        
        {# أزرار التعديل والحذف (فقط للمالك أو المشرف) #}
        {% if request.user == comment.user or request.user.is_superuser %}
            <a href="#" class="text-blue-500 hover:text-blue-700 transition duration-200" title="تعديل">
                <i class="fas fa-edit mr-1 rtl:mr-0 rtl:ml-1"></i>
            </a>
            <a href="#" class="text-red-500 hover:text-red-700 transition duration-200" title="حذف">
                <i class="fas fa-trash-alt mr-1 rtl:mr-0 rtl:ml-1"></i>
            </a>
        {% endif %}
    </div>

    {# حاوية نموذج الرد HTMX #}
    <div id="reply-form-{{ comment.id }}" class="mt-4">
        {# هنا يمكن تحميل نموذج الرد عبر HTMX #}
    </div>

    {# عرض الردود المتداخلة #}
    {% if comment.replies.all %}
        <div class="mt-4 space-y-4">
            {% for reply in comment.replies.all %}
                {# استدعاء CommentCard لنفسه مع زيادة المستوى #}
                {% include 'community/partials/comment_card.html' with comment=reply level=level|add:1 liked_comment_ids=liked_comment_ids post_content_type_id=post_content_type_id comment_content_type_id=comment_content_type_id %}
            {% endfor %}
        </div>
    {% endif %}
</div>
