{% extends 'base.html' %}
{% load static %}
{% load journal_extras %} {# <-- تحميل الفلتر المخصص #}

{% block title %}لوحة التحكم{% endblock %}

{% block content %}
<!-- =================================================================== -->
<!--          النافذة المنبثقة للإنجاز (باستخدام Alpine.js)          -->
<!-- =================================================================== -->
<div 
    x-data="{ 
        show: false, 
        achievement: null,
        celebrate(ach) {
            this.achievement = ach;
            this.show = true;
            this.$nextTick(() => {
                const confettiConfig = all_achievements_data.confetti_types[ach.confetti_type];
                if (confettiConfig) confetti(confettiConfig);
                
                const soundPath = all_achievements_data.sounds[ach.sound];
                if (soundPath) new Audio(soundPath).play().catch(e => console.error('Audio play failed:', e));
            });
        }
    }" 
    x-cloak
    x-show="show"
    @achievementsUnlocked.window="celebrate($event.detail.achievementsUnlocked[0])"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform scale-90"
    x-transition:enter-end="opacity-100 transform scale-100"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="opacity-100 transform scale-100"
    x-transition:leave-end="opacity-0 transform scale-90"
    class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4"
>
    <!-- محتوى النافذة -->
    <div class="bg-surface rounded-xl shadow-2xl p-8 text-center max-w-sm mx-auto" @click.away="show = false">
        <div class="text-6xl mx-auto" x-text="achievement?.badge_icon"></div>
        <h3 class="text-2xl font-bold mt-4" style="color: var(--color-text-primary);" x-text="achievement?.title"></h3>
        <p class="mt-2" style="color: var(--color-text-secondary);" x-text="achievement?.message"></p>
        <button @click="show = false" class="mt-6 text-white font-bold py-2 px-6 rounded-lg transition hover:scale-105 active:scale-95" style="background-color: var(--color-primary);">
            الحمد لله
        </button>
    </div>
</div>


<!-- رسالة ترحيب شخصية -->
<div class="mb-8">
    <h1 class="text-4xl font-bold" style="color: var(--color-text-primary);">أهلاً بعودتك، {{ user.username }}!</h1>
    <p class="text-lg mt-1" style="color: var(--color-text-secondary);">يوم جديد هو فرصة جديدة للنمو. أنت تقوم بعمل رائع.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- ========================================================== -->
    <!--            العمود الرئيسي: التركيز على اليوم              -->
    <!-- ========================================================== -->
    <div class="lg:col-span-2 space-y-8">

        <!-- بطاقة كتابة اليوميات (مع HTMX) -->
        <div id="entry-form-container" class="bg-surface rounded-xl shadow-lg p-6 transition-all duration-500">
            {% if already_written_today %}
                {% include 'journal/partials/daily_entry_success.html' %}
            {% else %}
                <h2 class="text-2xl font-bold mb-4" style="color: var(--color-text-primary);">يوميات اليوم</h2>
                <form hx-post="{% url 'dashboard' %}" hx-target="#entry-form-container" hx-swap="outerHTML">
                    {% csrf_token %}
                    <textarea name="daily_entry" rows="8" class="w-full bg-gray-50 border rounded-lg p-4 focus:outline-none focus:ring-2" style="border-color: var(--color-border); --tw-ring-color: var(--color-primary);" placeholder="كيف كان يومك اليوم؟ ما هي المشاعر التي مررت بها؟"></textarea>
                    <div class="text-left mt-4">
                        <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 ease-in-out hover:scale-105 active:scale-95" style="background-color: var(--color-primary);">
                            حفظ يوميات اليوم
                        </button>
                    </div>
                </form>
            {% endif %}
        </div>

        <!-- عرض الاقتباسات (Swiper) -->
        <div class="bg-surface rounded-xl shadow-lg p-6">
            <div class="swiper daily-quote-slider">
                <div class="swiper-wrapper">
                    {% with user_pref=request.user.profile.content_preference|default:"muslim" %}
                        {% for quote in all_achievements_data_json.quotes|get_item:user_pref %}
                        <div class="swiper-slide text-center">
                            <p class="text-lg italic" style="color: var(--color-text-primary);">"{{ quote.text }}"</p>
                            <p class="mt-2 text-sm" style="color: var(--color-accent);">- {{ quote.author }}</p>
                        </div>
                        {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================== -->
    <!--              العمود الجانبي: نظرة عامة ودعم               -->
    <!-- ========================================================== -->
    <div class="space-y-8">
        
        <!-- بطاقة تتبع التقدم مع شريط GSAP -->
        <div class="bg-surface rounded-xl shadow-lg p-6">
            <h3 class="font-bold text-center mb-4" style="color: var(--color-text-secondary);">تقدم رحلة الـ 90 يوماً</h3>
            {% with progress=(days_passed|default:0|floatformat:2 / target_days|floatformat:2) * 100 %}
            <div class="relative w-full rounded-full h-4" style="background-color: var(--color-border);">
                <div id="progress-bar" class="h-4 rounded-full" style="width: 0%; background-color: var(--color-primary);"></div>
            </div>
            <p id="progress-text" class="text-center mt-2 text-sm font-bold" style="color: var(--color-text-primary);">0%</p>
            {% endwith %}

            <div class="mt-4 pt-4 border-t text-center" style="border-color: var(--color-border);">
                <h4 class="font-bold" style="color: var(--color-text-primary);">أيام متتالية</h4>
                <p class="text-3xl font-bold" style="color: var(--color-accent);">{{ streak }}</p>
            </div>
        </div>

        <!-- الشخصية التفاعلية (Lottie) -->
        <div class="bg-surface rounded-xl shadow-lg p-6 flex flex-col items-center">
            <h3 class="font-bold mb-2" style="color: var(--color-text-secondary);">رفيق رحلتك</h3>
            <!-- حاوية Lottie -->
            <div id="lottie-character" data-level="{{ character_level }}" style="width: 200px; height: 200px; cursor: pointer;"></div>
            <p class="text-sm text-center" style="color: var(--color-text-secondary);">يتطور مع تطورك. انقر عليه لترى تفاعله!</p>
        </div>

    </div>
</div>


<!-- ========================================================== -->
<!--                        سكربتات خاصة بالصفحة                    -->
<!-- ========================================================== -->

<!-- تمرير بيانات JSON من Django إلى JavaScript بأمان -->
{{ all_achievements_data_json|json_script:"achievements-data" }}

<script>
// قراءة البيانات من القالب مرة واحدة عند تحميل الصفحة
const all_achievements_data = JSON.parse(document.getElementById('achievements-data').textContent);

document.addEventListener('DOMContentLoaded', () => {

    // --- 1. تهيئة شريط التقدم (GSAP) ---
    {% with progress=(days_passed|default:0|floatformat:2 / target_days|floatformat:2) * 100 %}
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const targetWidth = {{ progress|default:0 }};

    gsap.to(progressBar, {
        width: targetWidth + "%",
        duration: 2,
        ease: "power2.out",
        onUpdate: function() {
            progressText.innerText = Math.round(this.progress() * targetWidth) + "%";
        }
    });
    {% endwith %}

    // --- 2. تهيئة الشخصية التفاعلية (Lottie) ---
    const lottieContainer = document.getElementById('lottie-character');
    if (lottieContainer) {
        const currentLevel = parseInt(lottieContainer.dataset.level, 10);
        
        const animation = lottie.loadAnimation({
            container: lottieContainer,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: "{% static 'lottie/plant_character.json' %}"
        });

        const animationSpeed = 1 + (currentLevel * 0.15);
        const animationScale = 1 + (currentLevel * 0.05);

        animation.setSpeed(animationSpeed);
        lottieContainer.style.transform = `scale(${animationScale})`;

        lottieContainer.addEventListener('click', () => {
            animation.setSpeed(animationSpeed * 2);
            setTimeout(() => {
                animation.setSpeed(animationSpeed);
            }, 1000);
        });
    }

    // --- 3. تهيئة عرض الاقتباسات (Swiper) ---
    const swiperContainer = document.querySelector('.daily-quote-slider');
    if (swiperContainer) {
        const swiper = new Swiper(swiperContainer, {
            loop: true,
            autoplay: { delay: 8000, disableOnInteraction: false },
            effect: 'fade',
            fadeEffect: { crossFade: true },
        });
    }

});
</script>
{% endblock %}