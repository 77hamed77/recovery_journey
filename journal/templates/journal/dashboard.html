{% extends 'base.html' %}
{% load static %}

{% block title %}لوحة التحكم{% endblock %}

{% block content %}
<!-- ============================================= -->
<!--          النافذة المنبثقة للإنجاز (Alpine.js)          -->
<!-- ============================================= -->
<div 
    x-data="{ show: false, achievement: null }" 
    x-cloak
    x-show="show"
    @achievementsUnlocked.window="
        achievement = $event.detail.achievementsUnlocked[0];
        show = true;
        $nextTick(() => {
            // هنا يمكنك إضافة منطق تشغيل الصوت أو مؤثرات Lottie إذا أردت
        });
    "
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform scale-90"
    x-transition:enter-end="opacity-100 transform scale-100"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="opacity-100 transform scale-100"
    x-transition:leave-end="opacity-0 transform scale-90"
    class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4"
>
    <!-- محتوى النافذة -->
    <div class="bg-surface rounded-xl shadow-2xl p-8 text-center max-w-sm mx-auto" @click.away="show = false">
        <div class="text-6xl mx-auto" x-text="achievement?.badge_icon"></div>
        <h3 class="text-2xl font-bold mt-4" style="color: var(--color-text-primary);" x-text="achievement?.title"></h3>
        <p class="mt-2" style="color: var(--color-text-secondary);" x-text="achievement?.message"></p>
        <button @click="show = false" class="mt-6 text-white font-bold py-2 px-6 rounded-lg transition hover:scale-105 active:scale-95" style="background-color: var(--color-primary);">
            متابعة
        </button>
    </div>
</div>


<!-- رسالة ترحيب شخصية -->
<div class="mb-8">
    <h1 class="text-4xl font-bold" style="color: var(--color-text-primary);">أهلاً بعودتك، {{ user.username }}!</h1>
    <p class="text-lg mt-1" style="color: var(--color-text-secondary);">يوم جديد هو فرصة جديدة للنمو. أنت تقوم بعمل رائع.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- ========================================================== -->
    <!--            العمود الرئيسي: التركيز على اليوم              -->
    <!-- ========================================================== -->
    <div class="lg:col-span-2 space-y-8">

        <!-- بطاقة كتابة اليوميات (مع HTMX) -->
        <div id="entry-form-container" class="bg-surface rounded-xl shadow-lg p-6 transition-all duration-500">
            {% if already_written_today %}
                {% include 'journal/partials/daily_entry_success.html' %}
            {% else %}
                <h2 class="text-2xl font-bold mb-4" style="color: var(--color-text-primary);">يوميات اليوم</h2>
                <form hx-post="{% url 'dashboard' %}" hx-target="#entry-form-container" hx-swap="outerHTML">
                    {% csrf_token %}
                    <textarea name="daily_entry" rows="8" class="w-full bg-gray-50 border rounded-lg p-4 focus:outline-none focus:ring-2" style="border-color: var(--color-border); --tw-ring-color: var(--color-primary);" placeholder="كيف كان يومك اليوم؟ ما هي المشاعر التي مررت بها؟"></textarea>
                    <div class="text-left mt-4">
                        <button type="submit" class="text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 ease-in-out hover:scale-105 active:scale-95" style="background-color: var(--color-primary);">
                            حفظ يوميات اليوم
                        </button>
                    </div>
                </form>
            {% endif %}
        </div>

        <!-- عرض الاقتباسات (Swiper) -->
        <div class="bg-surface rounded-xl shadow-lg p-6">
            <div class="swiper daily-quote-slider">
                <div class="swiper-wrapper">
                    {% for quote in all_achievements_data_json.quotes %}
                    <div class="swiper-slide text-center">
                        <p class="text-lg italic" style="color: var(--color-text-primary);">"{{ quote.text }}"</p>
                        <p class="mt-2 text-sm" style="color: var(--color-accent);">- {{ quote.author }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================================== -->
    <!--              العمود الجانبي: نظرة عامة ودعم               -->
    <!-- ========================================================== -->
    <div class="space-y-8">
        
        <!-- بطاقة تتبع التقدم مع شريط GSAP -->
        <div class="bg-surface rounded-xl shadow-lg p-6">
            <h3 class="font-bold text-center mb-4" style="color: var(--color-text-secondary);">تقدم رحلة الـ 90 يوماً</h3>
            {% with progress=(days_passed|default:0|floatformat:2 / target_days|floatformat:2) * 100 %}
            <div class="relative w-full rounded-full h-4" style="background-color: var(--color-border);">
                <div id="progress-bar" class="h-4 rounded-full" style="width: 0%; background-color: var(--color-primary);"></div>
                <div id="sparks-container" class="absolute top-0 left-0 h-full w-full"></div>
            </div>
            <p id="progress-text" class="text-center mt-2 text-sm font-bold" style="color: var(--color-text-primary);">0%</p>
            {% endwith %}

            <div class="mt-4 pt-4 border-t text-center" style="border-color: var(--color-border);">
                <h4 class="font-bold" style="color: var(--color-text-primary);">أيام متتالية</h4>
                <p class="text-3xl font-bold" style="color: var(--color-accent);">{{ streak }}</p>
            </div>
        </div>

        <!-- الشخصية التفاعلية (Rive) -->
        <div class="bg-surface rounded-xl shadow-lg p-6 flex flex-col items-center">
            <h3 class="font-bold mb-2" style="color: var(--color-text-secondary);">رفيق رحلتك</h3>
            <canvas id="rive-character" width="200" height="200" data-level="{{ character_level }}"></canvas>
            <p class="text-sm text-center" style="color: var(--color-text-secondary);">يتطور مع تطورك. انقر عليه لترى تفاعله!</p>
        </div>

    </div>
</div>


<!-- ========================================================== -->
<!--                        سكربتات خاصة بالصفحة                    -->
<!-- ========================================================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. تهيئة شريط التقدم (GSAP) ---
    {% with progress=(days_passed|default:0|floatformat:2 / target_days|floatformat:2) * 100 %}
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const targetWidth = {{ progress|default:0 }};

    gsap.to(progressBar, {
        width: targetWidth + "%",
        duration: 2,
        ease: "power2.out",
        onUpdate: function() {
            // تحديث النص مع تقريب الرقم
            progressText.innerText = Math.round(this.progress() * targetWidth) + "%";
        }
    });
    {% endwith %}


    // --- 2. تهيئة الشخصية التفاعلية (Rive) ---
    const riveCanvas = document.getElementById('rive-character');
    const currentLevel = parseInt(riveCanvas.dataset.level, 10);

    const riveInstance = new rive.Rive({
        src: "{% static 'rive/plant_character.riv' %}",
        canvas: riveCanvas,
        autoplay: true,
        stateMachines: "GrowthSM",
        onLoad: () => {
            riveInstance.resizeToCanvas();
            const inputs = riveInstance.stateMachineInputs("GrowthSM");
            const levelInput = inputs.find(i => i.name === 'Level');
            if(levelInput) levelInput.value = currentLevel;

            riveCanvas.addEventListener('click', () => {
                const clickInput = inputs.find(i => i.name === 'ClickTrigger');
                if (clickInput) clickInput.fire();
            });
        },
    });


    // --- 3. تهيئة عرض الاقتباسات (Swiper) ---
    const swiper = new Swiper('.daily-quote-slider', {
        loop: true,
        autoplay: { delay: 8000, disableOnInteraction: false },
        effect: 'fade',
        fadeEffect: { crossFade: true },
    });

});
</script>
{% endblock %}